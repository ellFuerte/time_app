{"ast":null,"code":"import _objectSpread from\"D:/Download/time_app/client/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"D:/Download/time_app/client/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"D:/Download/time_app/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _toConsumableArray from\"D:/Download/time_app/client/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _slicedToArray from\"D:/Download/time_app/client/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{useEffect,useState}from'react';import axios from'axios';import Employee from'../Employee/Employee';import'./Staff.css';import{useParams}from'react-router-dom';import Modal from'../Templates/Modal/Modal';import{jsx as _jsx}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export default function Staff(){var _localUser$checkedDep5;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),users=_useState2[0],setUsers=_useState2[1];var _useState3=useState([]),_useState4=_slicedToArray(_useState3,2),user=_useState4[0],setUser=_useState4[1];var _useState5=useState([]),_useState6=_slicedToArray(_useState5,2),deps=_useState6[0],setDeps=_useState6[1];var _useState7=useState(false),_useState8=_slicedToArray(_useState7,2),isOpen=_useState8[0],setIsOpen=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),isFetching=_useState10[0],setIsFetching=_useState10[1];var departId=useParams().username;var localUser=JSON.parse(localStorage.getItem('user'));var _useState11=useState(false),_useState12=_slicedToArray(_useState11,2),modalActive=_useState12[0],setModalActive=_useState12[1];var _useState13=useState(false),_useState14=_slicedToArray(_useState13,2),modalMain=_useState14[0],setModalMain=_useState14[1];var changedArr=[];var _useState15=useState(false),_useState16=_slicedToArray(_useState15,2),isModalFetching=_useState16[0],setIsModalFetching=_useState16[1];for(var i=0;i<((_localUser$checkedDep=localUser.checkedDeps)===null||_localUser$checkedDep===void 0?void 0:_localUser$checkedDep.length);i++){var _localUser$checkedDep;changedArr.push(localUser.checkedDeps[i]);}// ставит галочки в модалке\nfunction addChecked(deps){for(var _i=0;_i<deps.length;_i++){for(var j=0;j<((_localUser$checkedDep2=localUser.checkedDeps)===null||_localUser$checkedDep2===void 0?void 0:_localUser$checkedDep2.length);j++){var _localUser$checkedDep2;if(deps[_i]._id===localUser.checkedDeps[j]){deps[_i].checked=true;}}}}// фильтр нужных департаментов\nvar currentDep=deps.filter(function(dep){return departId?dep._id===departId:dep._id===localUser.departmentId;});var filterDeps=deps.filter(function(dep){return currentDep[0].children.find(function(i){return i===dep.dep_id||i===currentDep[0].dep_id;});});filterDeps.push.apply(filterDeps,_toConsumableArray(currentDep));// фильтр нужных людей\nvar usersFilter=users.filter(function(user){return filterDeps.find(function(f){return f._id===user.departmentId;});});var usersFilterDeps=users.filter(function(user){var _localUser$checkedDep3;return(_localUser$checkedDep3=localUser.checkedDeps)===null||_localUser$checkedDep3===void 0?void 0:_localUser$checkedDep3.find(function(f){return f===user.departmentId;});});var depsFilterDeps=deps.filter(function(dep){var _localUser$checkedDep4;return(_localUser$checkedDep4=localUser.checkedDeps)===null||_localUser$checkedDep4===void 0?void 0:_localUser$checkedDep4.find(function(f){return f===dep._id;});});var isLockDeps=localUser.checkedDeps!==null&&((_localUser$checkedDep5=localUser.checkedDeps)===null||_localUser$checkedDep5===void 0?void 0:_localUser$checkedDep5.length)>0;var addChildrenArr=[];useEffect(function(){// получение всех пользователей\nvar fetchUsers=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var res,filterUsers;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:setIsFetching(true);_context.next=3;return axios.get('/api/users/allusers/1');case 3:res=_context.sent;res.data.sort(function(a,b){return a.username.localeCompare(b.username);});filterUsers=filterUsersFoo(res.data);setUsers(filterUsers);setIsFetching(false);case 8:case\"end\":return _context.stop();}}},_callee);}));return function fetchUsers(){return _ref.apply(this,arguments);};}();// получение данных о себе\nvar fetchUser=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var res;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return axios.get('/api/user/'+user._id);case 2:res=_context2.sent;setUser(res.data);setIsFetching(false);case 5:case\"end\":return _context2.stop();}}},_callee2);}));return function fetchUser(){return _ref2.apply(this,arguments);};}();// получение и фильтр департаментов\nvar getDeps=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var res,_loop,_i2,newArr;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:setIsModalFetching(true);_context3.next=3;return axios.get('/api/departments/');case 3:res=_context3.sent;addChecked(res.data);_loop=function _loop(_i2){var _loop2=function _loop2(j){if(res.data[_i2].children.find(function(k){return k===res.data[j].dep_id&&k!==res.data[_i2].dep_id;})){if(res.data[j].margin){res.data[j].margin+=10;}else{res.data[j].margin=10;}}};for(var j=_i2+1;j<res.data.length;j++){_loop2(j);}};for(_i2=0;_i2<res.data.length-1;_i2++){_loop(_i2);}newArr=res.data.filter(function(d){return d.dep_id!==7;});newArr.push(res.data[6]);setDeps(newArr);setIsModalFetching(false);case 11:case\"end\":return _context3.stop();}}},_callee3);}));return function getDeps(){return _ref3.apply(this,arguments);};}();getDeps();fetchUser();setIsOpen(false);fetchUsers();},[departId]);// фильтр пользователей по статусу\nfunction filterUsersFoo(users){return users.filter(function(user){return user.status===1;}).concat(users.filter(function(user){return user.status===2;})).concat(users.filter(function(user){return user.status===3;})).concat(users.filter(function(user){return user.status!==1&&user.status!==2&&user.status!==3&&user.status!==4;})).concat(users.filter(function(user){return user.status===4;}));}var handleClick=function handleClick(){if(departId){setIsOpen(true);}else{setModalActive(true);}};// добавляем/удаляем департамент в модалке\nvar handlePush=function handlePush(e){if(e.target.checked){changedArr.push(e.target.value);}else{var index=changedArr.indexOf(e.target.value);changedArr.splice(index,1);delete e.target.checked;}};// добавление дочерних\nvar handleAddChildren=function handleAddChildren(e){if(e.target.checked){var _currentDep=deps.filter(function(dep){return departId?dep._id===departId:dep._id===localUser.departmentId;});addChildrenArr=deps.filter(function(dep){return _currentDep[0].children.find(function(i){return i===dep.dep_id||i===_currentDep[0].dep_id;});});}else{addChildrenArr=[];}};// обновляем данные модального окна\nvar handleModalClick=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(e){var newInfo;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:e.preventDefault();if(departId){addChildrenArr=addChildrenArr.map(function(i){return i._id;});newInfo={userId:user._id,checkedDeps:[departId].concat(_toConsumableArray(addChildrenArr))};}else{newInfo={userId:user._id,checkedDeps:changedArr};}_context4.prev=2;_context4.next=5;return axios.put('/api/user/'+localUser._id,newInfo);case 5:if(user._id===localUser._id){localStorage.setItem('user',JSON.stringify(_objectSpread(_objectSpread({},user),newInfo)));}window.location.reload();_context4.next=12;break;case 9:_context4.prev=9;_context4.t0=_context4[\"catch\"](2);console.log(_context4.t0);case 12:case\"end\":return _context4.stop();}}},_callee4,null,[[2,9]]);}));return function handleModalClick(_x){return _ref4.apply(this,arguments);};}();return/*#__PURE__*/_jsxs(\"div\",{className:\"staff\",children:[!departId&&/*#__PURE__*/_jsx(\"div\",{className:\"changeDepsContainer\",children:/*#__PURE__*/_jsx(\"div\",{children:/*#__PURE__*/_jsx(\"span\",{className:\"changeDeps\",onClick:handleClick,children:\"\\u0418\\u0437\\u043C\\u0435\\u043D\\u0438\\u0442\\u044C\"})})}),departId&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"button\",{onClick:handleClick,className:\"btnStaff\",children:\"\\u041F\\u043E\\u043A\\u0430\\u0437\\u0430\\u0442\\u044C \\u0434\\u043E\\u0447\\u0435\\u0440\\u043D\\u0438\\u0435\"}),/*#__PURE__*/_jsx(\"button\",{onClick:function onClick(){return setIsOpen(false);},className:\"btnStaff\",children:\"\\u0421\\u043A\\u0440\\u044B\\u0442\\u044C \\u0434\\u043E\\u0447\\u0435\\u0440\\u043D\\u0438\\u0435\"}),/*#__PURE__*/_jsx(\"button\",{onClick:function onClick(){return setModalMain(true);},className:\"btnStaff\",style:{float:'right'},children:\"\\u0421\\u0434\\u0435\\u043B\\u0430\\u0442\\u044C \\u0433\\u043B\\u0430\\u0432\\u043D\\u043E\\u0439\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"employeeWrapper\",children:isFetching?/*#__PURE__*/_jsx(\"div\",{className:\"isFetching\",children:\"\\u0417\\u0430\\u0433\\u0440\\u0443\\u0437\\u043A\\u0430...\"}):users.length===0?/*#__PURE__*/_jsx(\"div\",{className:\"emptyStaff\",children:\"\\u0421\\u043F\\u0438c\\u043E\\u043A \\u043F\\u0443\\u0441\\u0442\"}):departId?!isOpen?users.filter(function(user){return user.departmentId===departId;}).map(function(user,id){return/*#__PURE__*/_jsx(Employee,{user:user},id);}):usersFilter.map(function(user,id){return/*#__PURE__*/_jsx(Employee,{user:user},id);}):isLockDeps?usersFilterDeps.map(function(user,id){return/*#__PURE__*/_jsx(Employee,{user:user},id);}):users.map(function(user,id){return/*#__PURE__*/_jsx(Employee,{user:user},id);})}),/*#__PURE__*/_jsxs(Modal,{active:modalActive,setActive:setModalActive,children:[/*#__PURE__*/_jsx(\"h1\",{children:\"\\u0418\\u0437\\u043C\\u0435\\u043D\\u0435\\u043D\\u0438\\u0435 \\u0438\\u043D\\u0444\\u043E\\u0440\\u043C\\u0430\\u0446\\u0438\\u0438:\"}),/*#__PURE__*/_jsx(\"hr\",{}),/*#__PURE__*/_jsxs(\"form\",{className:\"modalLoginBox\",children:[isModalFetching?/*#__PURE__*/_jsx(\"div\",{children:\"\\u0417\\u0430\\u0433\\u0440\\u0443\\u0437\\u043A\\u0430\"}):deps.map(function(dep,id){return/*#__PURE__*/_jsxs(\"label\",{htmlFor:dep.departmentName,style:{paddingLeft:\"\".concat(dep.margin,\"px\")},children:[/*#__PURE__*/_jsx(\"input\",{type:\"checkbox\",value:dep._id,id:dep.departmentName,name:dep.departmentName,onChange:handlePush,checked:dep.checked}),dep.departmentName]},id);}),/*#__PURE__*/_jsx(\"button\",{className:\"ModalButton\",type:\"submit\",disabled:isFetching,onClick:handleModalClick,children:\"\\u0418\\u0437\\u043C\\u0435\\u043D\\u0438\\u0442\\u044C\"})]})]}),/*#__PURE__*/_jsxs(Modal,{active:modalMain,setActive:setModalMain,children:[/*#__PURE__*/_jsx(\"h1\",{children:\"\\u0418\\u0437\\u043C\\u0435\\u043D\\u0435\\u043D\\u0438\\u0435 \\u0438\\u043D\\u0444\\u043E\\u0440\\u043C\\u0430\\u0446\\u0438\\u0438:\"}),/*#__PURE__*/_jsx(\"hr\",{}),/*#__PURE__*/_jsxs(\"form\",{className:\"modalLoginBox\",children:[/*#__PURE__*/_jsxs(\"label\",{children:[/*#__PURE__*/_jsx(\"input\",{type:\"checkbox\",onChange:handleAddChildren}),\"\\u0414\\u043E\\u0431\\u0430\\u0432\\u0438\\u0442\\u044C \\u0434\\u043E\\u0447\\u0435\\u0440\\u043D\\u0438\\u0435\"]}),/*#__PURE__*/_jsx(\"button\",{className:\"ModalButton\",type:\"submit\",disabled:isFetching,onClick:handleModalClick,children:\"\\u0418\\u0437\\u043C\\u0435\\u043D\\u0438\\u0442\\u044C\"})]})]})]});}","map":{"version":3,"sources":["D:/Download/time_app/client/src/components/Staff/Staff.jsx"],"names":["useEffect","useState","axios","Employee","useParams","Modal","Staff","users","setUsers","user","setUser","deps","setDeps","isOpen","setIsOpen","isFetching","setIsFetching","departId","username","localUser","JSON","parse","localStorage","getItem","modalActive","setModalActive","modalMain","setModalMain","changedArr","isModalFetching","setIsModalFetching","i","checkedDeps","length","push","addChecked","j","_id","checked","currentDep","filter","dep","departmentId","filterDeps","children","find","dep_id","usersFilter","f","usersFilterDeps","depsFilterDeps","isLockDeps","addChildrenArr","fetchUsers","get","res","data","sort","a","b","localeCompare","filterUsers","filterUsersFoo","fetchUser","getDeps","k","margin","newArr","d","status","concat","handleClick","handlePush","e","target","value","index","indexOf","splice","handleAddChildren","handleModalClick","preventDefault","map","newInfo","userId","put","setItem","stringify","window","location","reload","console","log","float","id","departmentName","paddingLeft"],"mappings":"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","sourcesContent":["import { useEffect, useState } from 'react'\r\nimport axios from 'axios'\r\n\r\nimport Employee from '../Employee/Employee'\r\nimport './Staff.css'\r\nimport { useParams } from 'react-router-dom'\r\nimport Modal from '../Templates/Modal/Modal'\r\n\r\nexport default function Staff() {\r\n  const [users, setUsers] = useState([])\r\n  const [user, setUser] = useState([])\r\n  const [deps, setDeps] = useState([])\r\n  const [isOpen, setIsOpen] = useState(false)\r\n  const [isFetching, setIsFetching] = useState(false)\r\n  const departId = useParams().username\r\n\r\n  const localUser = JSON.parse(localStorage.getItem('user'))\r\n\r\n  const [modalActive, setModalActive] = useState(false)\r\n  const [modalMain, setModalMain] = useState(false)\r\n  const changedArr = []\r\n  const [isModalFetching, setIsModalFetching] = useState(false)\r\n\r\n  for(let i=0; i<localUser.checkedDeps?.length; i++){\r\n    changedArr.push(localUser.checkedDeps[i])\r\n  }\r\n\r\n  // ставит галочки в модалке\r\n  function addChecked(deps){\r\n    for(let i=0; i < deps.length; i++){\r\n      for(let j=0; j < localUser.checkedDeps?.length; j++){\r\n        if(deps[i]._id === localUser.checkedDeps[j]){\r\n          deps[i].checked = true\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // фильтр нужных департаментов\r\n  const currentDep = deps.filter(dep => departId ? dep._id === departId : dep._id === localUser.departmentId)\r\n  let filterDeps = deps.filter(dep => currentDep[0].children.find(i => i === dep.dep_id || i === currentDep[0].dep_id))\r\n  filterDeps.push(...currentDep)\r\n\r\n  // фильтр нужных людей\r\n  const usersFilter = users.filter(user => filterDeps.find(f => f._id === user.departmentId))\r\n  const usersFilterDeps = users.filter(user => localUser.checkedDeps?.find(f => f === user.departmentId))\r\n  const depsFilterDeps = deps.filter(dep => localUser.checkedDeps?.find(f => f === dep._id))\r\n\r\n  const isLockDeps = localUser.checkedDeps !== null && localUser.checkedDeps?.length > 0\r\n\r\n  let addChildrenArr = []\r\n\r\n  useEffect(() => {\r\n\r\n    // получение всех пользователей\r\n    const fetchUsers = async () => {\r\n      setIsFetching(true)\r\n      const res = await axios.get('/api/users/allusers/1')\r\n      res.data.sort((a, b) => a.username.localeCompare(b.username))\r\n      let filterUsers = filterUsersFoo(res.data)\r\n      setUsers(filterUsers)\r\n      setIsFetching(false)\r\n    }\r\n\r\n    // получение данных о себе\r\n    const fetchUser = async () => {\r\n\r\n      const res = await axios.get('/api/user/'+user._id)\r\n\r\n      setUser(res.data)\r\n      setIsFetching(false)\r\n    }\r\n\r\n    // получение и фильтр департаментов\r\n    const getDeps = async () => {\r\n      setIsModalFetching(true)\r\n      const res = await axios.get('/api/departments/')\r\n      addChecked(res.data)\r\n\r\n      for(let i = 0; i < res.data.length-1; i++){\r\n        for(let j = i+1; j < res.data.length; j++){\r\n          if(res.data[i].children.find(k => k === res.data[j].dep_id && k !== res.data[i].dep_id)){\r\n            if(res.data[j].margin ){\r\n              res.data[j].margin += 10\r\n            } else {\r\n              res.data[j].margin = 10\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      let newArr = res.data.filter(d => d.dep_id !== 7)\r\n      newArr.push(res.data[6])\r\n\r\n      setDeps(newArr)\r\n      setIsModalFetching(false)\r\n    }\r\n\r\n    getDeps()\r\n    fetchUser()\r\n    setIsOpen(false)\r\n    fetchUsers()\r\n  }, [departId])\r\n\r\n  // фильтр пользователей по статусу\r\n  function filterUsersFoo(users){\r\n    return users.filter(user => user.status === 1)\r\n    .concat(users.filter(user => user.status === 2))\r\n    .concat(users.filter(user => user.status === 3))\r\n    .concat(users.filter(user => user.status !== 1 && user.status !== 2 && user.status !== 3 && user.status !== 4))\r\n    .concat(users.filter(user => user.status === 4))\r\n  }\r\n\r\n  const handleClick = () => {\r\n    if(departId){\r\n      setIsOpen(true)\r\n    }else{\r\n      setModalActive(true)\r\n    }\r\n  }\r\n\r\n  // добавляем/удаляем департамент в модалке\r\n  const handlePush = e => {\r\n    if (e.target.checked) {\r\n      changedArr.push(e.target.value)\r\n    }else{\r\n      const index = changedArr.indexOf(e.target.value)\r\n      changedArr.splice(index, 1)\r\n      delete e.target.checked\r\n    }\r\n  }\r\n\r\n  // добавление дочерних\r\n  const handleAddChildren = e => {\r\n    if (e.target.checked) {\r\n      const currentDep = deps.filter(dep => departId ? dep._id === departId : dep._id === localUser.departmentId)\r\n      addChildrenArr = deps.filter(dep => currentDep[0].children.find(i => i === dep.dep_id || i === currentDep[0].dep_id))\r\n    }else{\r\n      addChildrenArr = []\r\n    }\r\n  }\r\n\r\n  // обновляем данные модального окна\r\n  const handleModalClick = async (e) => {\r\n    e.preventDefault()\r\n\r\n    let newInfo\r\n\r\n    if(departId){\r\n      addChildrenArr = addChildrenArr.map(i => i._id)\r\n      newInfo= {\r\n        userId: user._id,\r\n        checkedDeps: [departId, ...addChildrenArr]\r\n      }\r\n    }else{\r\n      newInfo= {\r\n        userId: user._id,\r\n        checkedDeps: changedArr\r\n      }\r\n    }\r\n\r\n    try {\r\n      await axios.put('/api/user/'+localUser._id, newInfo)\r\n      if(user._id === localUser._id){\r\n        localStorage.setItem('user', JSON.stringify({...user, ...newInfo}))\r\n      }\r\n      window.location.reload()\r\n    } catch (error) {\r\n      console.log(error);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className='staff'>\r\n      { !departId && <div className='changeDepsContainer'>\r\n        <div><span className='changeDeps' onClick={handleClick}>Изменить</span></div>\r\n      </div>}\r\n      {departId && <>\r\n        <button onClick={handleClick} className='btnStaff'>Показать дочерние</button>\r\n        <button onClick={() => setIsOpen(false)} className='btnStaff'>Скрыть дочерние</button>\r\n        <button onClick={() => setModalMain(true)} className='btnStaff' style={{float: 'right'}}>Сделать главной</button>\r\n      </>}\r\n      <div className=\"employeeWrapper\">\r\n        {isFetching\r\n          ? <div className='isFetching'>Загрузка...</div>\r\n          : users.length === 0 \r\n            ? <div className='emptyStaff'>Спиcок пуст</div> \r\n            : departId \r\n              ? !isOpen \r\n                ? users.filter(user => user.departmentId === departId).map((user, id) => <Employee key={id} user={user}/>)\r\n                : usersFilter.map((user, id) => <Employee key={id} user={user}/>)\r\n              : isLockDeps \r\n                ? usersFilterDeps.map((user, id) => <Employee key={id} user={user}/>) \r\n                : users.map((user, id) => <Employee key={id} user={user}/>) \r\n        }\r\n      </div>\r\n      <Modal active={modalActive} setActive={setModalActive}>\r\n        <h1>Изменение информации:</h1>\r\n        <hr/>\r\n        <form className=\"modalLoginBox\">\r\n          {isModalFetching \r\n            ?<div>Загрузка</div>\r\n            : deps.map((dep, id) => <label key={id} htmlFor={dep.departmentName} style={{paddingLeft: `${dep.margin}px`}}>\r\n            <input\r\n              type='checkbox'\r\n              value={dep._id}\r\n              id={dep.departmentName}\r\n              name={dep.departmentName}\r\n              onChange={handlePush}\r\n              checked={dep.checked}\r\n            />{dep.departmentName}</label>)\r\n          }\r\n          <button className=\"ModalButton\" type=\"submit\" disabled={isFetching} onClick={handleModalClick}>\r\n            Изменить\r\n          </button>\r\n        </form>\r\n      </Modal>\r\n      <Modal active={modalMain} setActive={setModalMain}>\r\n        <h1>Изменение информации:</h1>\r\n        <hr/>\r\n        <form className=\"modalLoginBox\">\r\n          <label>\r\n            <input\r\n              type='checkbox'\r\n              onChange={handleAddChildren}\r\n            />Добавить дочерние</label>\r\n          <button className=\"ModalButton\" type=\"submit\" disabled={isFetching} onClick={handleModalClick}>\r\n            Изменить\r\n          </button>\r\n        </form>\r\n      </Modal>\r\n    </div>\r\n  )\r\n}\r\n"]},"metadata":{},"sourceType":"module"}